name: CI - 백엔드 API 배포

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
  IMAGE_TAG: ${{ github.sha }}
  MANIFEST_REPO: Cloud-Infra-Education/Manifests

jobs:
  build-push-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Check backend-api repo
        id: check-backend
        continue-on-error: true
        run: aws ecr describe-repositories --repository-names backend-api > /dev/null 2>&1 && echo "exists=true" >> $GITHUB_OUTPUT || echo "exists=false" >> $GITHUB_OUTPUT

      - name: Check user-service repo
        id: check-user-service
        continue-on-error: true
        run: aws ecr describe-repositories --repository-names user-service > /dev/null 2>&1 && echo "exists=true" >> $GITHUB_OUTPUT || echo "exists=false" >> $GITHUB_OUTPUT

      - name: Build (backend-api)
        if: steps.check-backend.outputs.exists == 'true'
        run: docker build -t ${ECR_REGISTRY}/backend-api:${IMAGE_TAG} .

      - name: Trivy Scan (backend-api)
        if: steps.check-backend.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/backend-api:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          scanners: 'vuln'
          trivyignores: '.trivyignore'
        continue-on-error: true

      - name: Delete existing latest tag if exists
        if: steps.check-backend.outputs.exists == 'true'
        continue-on-error: true
        run: aws ecr batch-delete-image --repository-name backend-api --image-ids imageTag=latest --region ${AWS_REGION} || echo "No latest tag to delete"

      - name: Build latest tag
        if: steps.check-backend.outputs.exists == 'true'
        run: docker tag ${ECR_REGISTRY}/backend-api:${IMAGE_TAG} ${ECR_REGISTRY}/backend-api:latest

      - name: Push (backend-api)
        if: steps.check-backend.outputs.exists == 'true'
        run: |
          docker push ${ECR_REGISTRY}/backend-api:${IMAGE_TAG}
          docker push ${ECR_REGISTRY}/backend-api:latest

      - name: Build (user-service)
        if: steps.check-user-service.outputs.exists == 'true'
        run: docker build -t ${ECR_REGISTRY}/user-service:${IMAGE_TAG} .

      - name: Trivy Scan (user-service)
        if: steps.check-user-service.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REGISTRY }}/user-service:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          scanners: 'vuln'
          trivyignores: '.trivyignore'
        continue-on-error: true

      - name: Delete existing v4 tag if exists (user-service)
        if: steps.check-user-service.outputs.exists == 'true'
        continue-on-error: true
        run: aws ecr batch-delete-image --repository-name user-service --image-ids imageTag=v4 --region ${AWS_REGION} || echo "No v4 tag to delete"

      - name: Build v4 tag (user-service)
        if: steps.check-user-service.outputs.exists == 'true'
        run: docker tag ${ECR_REGISTRY}/user-service:${IMAGE_TAG} ${ECR_REGISTRY}/user-service:v4

      - name: Push (user-service)
        if: steps.check-user-service.outputs.exists == 'true'
        run: |
          docker push ${ECR_REGISTRY}/user-service:${IMAGE_TAG}
          docker push ${ECR_REGISTRY}/user-service:v4

      - name: Update Manifest Repository
        if: steps.check-backend.outputs.exists == 'true' || steps.check-user-service.outputs.exists == 'true'
        env:
          MANIFEST_TOKEN: ${{ secrets.MANIFEST_REPO_TOKEN }}
          ECR_REGISTRY: ${{ env.ECR_REGISTRY }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          # Manifest Repo 클론
          git clone https://${MANIFEST_TOKEN}@github.com/${{ env.MANIFEST_REPO }}.git
          cd Manifests
          
          # Git 설정
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          COMMIT_MESSAGE=""
          
          # backend-api 이미지 태그 업데이트
          if [ "${{ steps.check-backend.outputs.exists }}" == "true" ]; then
            sed -i "s|image: ${ECR_REGISTRY}/backend-api:.*|image: ${ECR_REGISTRY}/backend-api:${IMAGE_TAG}|g" base/backend-api/deployment.yaml
            COMMIT_MESSAGE="${COMMIT_MESSAGE}Update backend-api image to ${IMAGE_TAG}; "
          fi
          
          # user-service 이미지 태그 업데이트
          if [ "${{ steps.check-user-service.outputs.exists }}" == "true" ]; then
            sed -i "s|image: ${ECR_REGISTRY}/user-service:.*|image: ${ECR_REGISTRY}/user-service:v4|g" base/user-service/deployment.yaml
            COMMIT_MESSAGE="${COMMIT_MESSAGE}Update user-service image to ${IMAGE_TAG}"
          fi
          
          # 변경사항 커밋 & 푸시
          git add .
          git commit -m "${COMMIT_MESSAGE}" || echo "No changes to commit"
          git push origin main


